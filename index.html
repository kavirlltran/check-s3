<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kiểm Tra Phát Âm với Web Speech API</title>
  <style>
    /* Hình nền với ảnh robot AI kiểu công nghệ tương lai */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: url('https://source.unsplash.com/1600x900/?robot,AI,futuristic') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    .overlay {
      background-color: rgba(0, 0, 0, 0.6);
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }
    #sentence-list {
      margin-bottom: 20px;
    }
    .sentence-item {
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .sentence-item:hover {
      background-color: rgba(255,255,255,0.1);
    }
    .sentence-item.selected {
      background-color: rgba(33,150,243,0.3);
      border-color: #2196f3;
      font-weight: bold;
    }
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #record-btn {
      padding: 10px 20px;
      font-size: 1.2em;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #2196f3;
      color: #fff;
      transition: background-color 0.3s;
    }
    #record-btn:hover {
      background-color: #1976d2;
    }
    #feedback {
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 10px;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1>Kiểm Tra Phát Âm</h1>
    <p style="text-align: center;">Chọn một câu bên dưới rồi nhấn <strong>Record</strong> để ghi âm. Các từ có dấu <code>'</code> (hoặc <code>‘</code>) đánh dấu trọng âm.</p>
    
    <!-- Danh sách các câu để chọn -->
    <div id="sentence-list"></div>
    
    <!-- Nút ghi âm duy nhất -->
    <div id="controls">
      <button id="record-btn">Record</button>
    </div>
    
    <!-- Phần nhận xét hiển thị kết quả -->
    <div id="feedback"></div>
  </div>
  
  <script>
    // Danh sách các câu có dấu trọng âm
    const sentences = [
      "We should ‘finish the ‘project for our ‘history ‘class",
      "‘Peter is re‘vising for his e‘xam ‘next ‘week.",
      "‘Students will ‘spend more ‘time ‘working with ‘other ‘classmates.",
      "I ‘like to ‘watch ‘videos that ‘help me ‘learn ‘new ‘things",
      "I have ‘installed some ‘apps on my ‘phone"
    ];
    
    let selectedSentenceIndex = null;
    let isRecording = false;
    let recognition = null;
    let finalTranscript = "";
    
    // Hàm loại bỏ dấu nhấn ( ' và ‘ ’ )
    function removeStressMarkers(text) {
      return text.replace(/['‘’]/g, "");
    }
    
    // Hàm so sánh từng từ, hiển thị từ sai màu đỏ
    function diffWords(correctSentence, transcript) {
      const correctWords = correctSentence.trim().toLowerCase().split(/\s+/);
      const transcriptWords = transcript.trim().toLowerCase().split(/\s+/);
      let output = "";
      const maxLen = Math.max(correctWords.length, transcriptWords.length);
      for (let i = 0; i < maxLen; i++) {
        const cw = correctWords[i] || "";
        const tw = transcriptWords[i] || "";
        if (cw === tw && tw !== "") {
          output += tw + " ";
        } else {
          if (tw !== "") {
            output += `<span style="color: red;">${tw}</span> `;
          } else if (cw !== "") {
            output += `<span style="color: red;">[${cw}]</span> `;
          }
        }
      }
      return output;
    }
    
    // Tạo danh sách câu cho người dùng lựa chọn
    const sentenceListDiv = document.getElementById("sentence-list");
    sentences.forEach((sentence, index) => {
      const sentenceDiv = document.createElement("div");
      sentenceDiv.className = "sentence-item";
      sentenceDiv.textContent = sentence;
      sentenceDiv.addEventListener("click", () => {
        // Đánh dấu câu được chọn
        document.querySelectorAll(".sentence-item").forEach(item => item.classList.remove("selected"));
        sentenceDiv.classList.add("selected");
        selectedSentenceIndex = index;
        // Xóa phần nhận xét khi thay đổi câu
        document.getElementById("feedback").innerHTML = "";
      });
      sentenceListDiv.appendChild(sentenceDiv);
    });
    
    // Kiểm tra hỗ trợ Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Trình duyệt của bạn không hỗ trợ Speech Recognition API. Vui lòng thử trên Chrome hoặc Edge.");
    }
    
    const recordBtn = document.getElementById("record-btn");
    const feedbackDiv = document.getElementById("feedback");
    
    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        // Bắt đầu ghi âm: yêu cầu chọn câu
        if (selectedSentenceIndex === null) {
          alert("Vui lòng chọn một câu để ghi âm.");
          return;
        }
        finalTranscript = "";
        recognition = new SpeechRecognition();
        recognition.continuous = true; // Không tự dừng khi có khoảng lặng
        recognition.interimResults = true;
        recognition.lang = "en-US";
        
        recognition.onresult = function(event) {
          let interimTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript + " ";
            } else {
              interimTranscript += event.results[i][0].transcript;
            }
          }
          const transcript = finalTranscript + interimTranscript;
          // Loại bỏ dấu trọng âm khỏi câu đúng để so sánh
          const correctSentence = removeStressMarkers(sentences[selectedSentenceIndex]);
          // Tạo diff hiển thị từ sai bằng màu đỏ
          const diffOutput = diffWords(correctSentence, transcript);
          feedbackDiv.innerHTML = diffOutput;
        };
        
        recognition.onerror = function(event) {
          console.error("Recognition error: ", event.error);
        };
        
        recognition.onend = function() {
          isRecording = false;
          recordBtn.textContent = "Record";
        };
        
        recognition.start();
        isRecording = true;
        recordBtn.textContent = "Stop";
      } else {
        // Dừng ghi âm khi nhấn nút lần nữa
        recognition.stop();
        isRecording = false;
        recordBtn.textContent = "Record";
      }
    });
  </script>
</body>
</html>
