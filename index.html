<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pronunciation Checker</title>
  <style>
    /* Global styles */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      min-height: 100vh;
      /* Kết hợp gradient overlay với ảnh nền */
      background: 
        linear-gradient(135deg, rgba(30,60,114,0.8), rgba(42,82,152,0.8)),
        url('—Pngtree—artificial intelligence robot illustration_9047239.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
      color: #fff;
      padding: 20px;
      position: relative;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    /* Cập nhật hình ảnh ở góc trên bên phải trong header */
    .header img {
      width: 80px;
      height: 80px;
    }
    .content {
      margin-top: 30px;
    }
    .line-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s, background 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    /* Khi dòng được chọn, highlight luôn sáng với nền sáng hơn và hiệu ứng glow */
    .line-box.active {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-5px);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
    }
    .line-box:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    .feedback {
      margin-top: 10px;
      background: rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 5px;
      font-size: 0.9rem;
    }
    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 100;
      align-items: center;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #ff5722;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover:not(:disabled) {
      background: #e64a19;
    }
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    .stress {
      color: #ffd700;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Load React, ReactDOM and Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
  <!-- Our React code -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Các dòng nội dung với dấu ' chỉ các âm tiết được nhấn mạnh.
    const lines = [
      "We should ‘finish the ‘project for our ‘history ‘class",
      "‘Peter is re‘vising for his e‘xam ‘next ‘week.",
      "‘Students will ‘spend more ‘time ‘working with ‘other ‘classmates.",
      "I ‘like to ‘watch ‘videos that ‘help me ‘learn ‘new ‘things",
      "I have ‘installed some ‘apps on my ‘phone"
    ];

    function App() {
      const [activeLineIndex, setActiveLineIndex] = useState(null);
      const [feedbacks, setFeedbacks] = useState({});
      const [recording, setRecording] = useState(false);
      const [transcript, setTranscript] = useState("");
      const recognitionRef = useRef(null);

      // Khi load trang, yêu cầu truy cập micro
      useEffect(() => {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            console.log("Microphone access granted on page load.");
            // Dừng ngay stream nếu không cần dùng, vì chỉ cần quyền là đủ.
            stream.getTracks().forEach(track => track.stop());
          })
          .catch(err => {
            console.error("Error accessing microphone: ", err);
          });
      }, []);

      // Khởi tạo Web Speech API nếu có hỗ trợ
      useEffect(() => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
          const recognition = new SpeechRecognition();
          recognition.continuous = true; // Ghi âm liên tục, chỉ dừng khi người dùng nhấn nút dừng
          recognition.interimResults = false;
          recognition.lang = "en-US";

          recognition.onresult = (event) => {
            let finalTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript + " ";
              }
            }
            setTranscript(finalTranscript.trim());
          };

          recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
          };

          recognitionRef.current = recognition;
        } else {
          console.warn("Speech Recognition API not supported in this browser.");
        }
      }, []);

      // Bắt đầu ghi âm
      const startRecording = () => {
        if (!recognitionRef.current) return;
        setTranscript("");
        setRecording(true);
        recognitionRef.current.start();
      };

      // Dừng ghi âm và tiến hành đánh giá
      const stopRecording = () => {
        if (!recognitionRef.current) return;
        recognitionRef.current.stop();
        setRecording(false);
        // Sau khi dừng ghi âm, tiến hành đánh giá phát âm
        setTimeout(() => {
          evaluatePronunciation();
        }, 500);
      };

      // So sánh transcript với nội dung dự kiến
      const evaluatePronunciation = () => {
        if (activeLineIndex === null) return;
        const expectedText = lines[activeLineIndex].replace(/‘/g, "'");
        const recognizedText = transcript.trim();
        const expectedWords = expectedText.split(/\s+/);
        const recognizedWords = recognizedText.split(/\s+/);

        const errors = expectedWords.map((word, idx) => {
          const cleanExpected = word.replace(/[.,?!]/g, "");
          const cleanRecognized = (recognizedWords[idx] || "").replace(/[.,?!]/g, "");
          return cleanExpected.toLowerCase() === cleanRecognized.toLowerCase() ? null : word;
        }).filter(word => word !== null);

        setFeedbacks(prev => ({
          ...prev,
          [activeLineIndex]: { recognizedText, errors }
        }));
      };

      // Hàm format để highlight các từ có dấu ' (trọng âm)
      const formatLine = (line) => {
        const formatted = line.replace(/‘(\S+)/g, "<span class='stress'>'$1</span>");
        return formatted;
      };

      return (
        <div className="container">
          <header className="header">
            <h1>Pronunciation Checker</h1>
            <!-- Cập nhật ảnh ở góc trên bên phải -->
            <img src="—Pngtree—artificial intelligence robot illustration_9047239.png" alt="AI Robot" />
          </header>
          <main className="content">
            {lines.map((line, index) => (
              <div
                key={index}
                className={`line-box ${activeLineIndex === index ? "active" : ""}`}
                onClick={() => setActiveLineIndex(index)}
              >
                <p dangerouslySetInnerHTML={{ __html: formatLine(line) }}></p>
                {feedbacks[index] && (
                  <div className="feedback">
                    <p><strong>Your reading:</strong> {feedbacks[index].recognizedText}</p>
                    {feedbacks[index].errors.length > 0 ? (
                      <p>
                        <strong>Mispronounced words:</strong> {feedbacks[index].errors.join(", ")}
                      </p>
                    ) : (
                      <p><strong>Excellent!</strong> All words pronounced correctly!</p>
                    )}
                  </div>
                )}
              </div>
            ))}
          </main>
          <div className="controls">
            {!recording ? (
              <button onClick={startRecording} disabled={activeLineIndex === null}>
                Start Recording
              </button>
            ) : (
              <button onClick={stopRecording}>Stop Recording</button>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
