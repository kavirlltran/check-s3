<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kiểm Tra Phát Âm với Web Speech API</title>
  <style>
    /* Thiết lập hình nền với hình robot AI kiểu công nghệ tương lai */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: url('https://source.unsplash.com/1600x900/?robot,AI,futuristic') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    /* Overlay nền đen bán trong suốt để tăng độ tương phản cho chữ */
    .overlay {
      background-color: rgba(0, 0, 0, 0.6);
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }
    .sentence-container {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px solid transparent;
      border-radius: 8px;
      transition: border 0.3s, background-color 0.3s;
    }
    /* Khi container đang ghi âm */
    .sentence-container.recording {
      border: 2px solid #ffeb3b;
      background-color: rgba(255, 235, 59, 0.2);
    }
    .sentence {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 10px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
    }
    .result {
      margin-top: 10px;
      font-weight: bold;
      color: #ffeb3b;
    }
    button {
      padding: 10px 15px;
      font-size: 1.1em;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #2196f3;
      color: #fff;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1976d2;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1>Kiểm Tra Phát Âm</h1>
    <p style="text-align: center;">
      Hãy đọc to các câu sau. Các từ có dấu <code>'</code> (hoặc <code>‘</code>) đánh dấu trọng âm.
      Nhấn nút <strong>Record</strong> để kiểm tra phát âm của bạn.
    </p>
    
    <div id="sentences"></div>
  </div>
  
  <script>
    // Danh sách các câu (với dấu ' hoặc ‘ đánh dấu trọng âm)
    const sentences = [
      "We should ‘finish the ‘project for our ‘history ‘class",
      "‘Peter is re‘vising for his e‘xam ‘next ‘week.",
      "‘Students will ‘spend more ‘time ‘working with ‘other ‘classmates.",
      "I ‘like to ‘watch ‘videos that ‘help me ‘learn ‘new ‘things",
      "I have ‘installed some ‘apps on my ‘phone"
    ];

    // Hàm loại bỏ dấu nhấn (dấu ' và ‘ ’)
    function removeStressMarkers(text) {
      return text.replace(/['‘’]/g, "");
    }

    const sentencesDiv = document.getElementById("sentences");
    // Lưu đối tượng SpeechRecognition đang hoạt động cho từng câu
    const activeRecognitions = {};

    // Kiểm tra sự hỗ trợ của Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Trình duyệt của bạn không hỗ trợ Speech Recognition API. Vui lòng thử trên Chrome hoặc Edge.");
    }

    // Tạo giao diện cho từng câu
    sentences.forEach((sentence, index) => {
      // Tạo container cho từng câu
      const container = document.createElement("div");
      container.className = "sentence-container";
      container.id = "sentence-container-" + index;

      // Hiển thị câu
      const sentenceEl = document.createElement("div");
      sentenceEl.className = "sentence";
      sentenceEl.textContent = sentence;
      container.appendChild(sentenceEl);

      // Tạo nút Record/Stop
      const recordBtn = document.createElement("button");
      recordBtn.textContent = "Record";
      recordBtn.id = "record-btn-" + index;
      container.appendChild(recordBtn);

      // Vùng hiển thị kết quả
      const resultDiv = document.createElement("div");
      resultDiv.className = "result";
      resultDiv.id = "result-" + index;
      container.appendChild(resultDiv);

      sentencesDiv.appendChild(container);

      // Sự kiện cho nút Record/Stop
      recordBtn.addEventListener("click", () => {
        if (activeRecognitions[index]) {
          // Nếu đang ghi âm, dừng lại
          activeRecognitions[index].stop();
          // Nút và container sẽ được cập nhật trong onend
        } else {
          startRecognition(index, sentence, recordBtn, container, resultDiv);
        }
      });
    });

    // Hàm sử dụng Web Speech API để nhận dạng giọng nói
    function startRecognition(index, sentence, recordBtn, container, resultDiv) {
      const recognition = new SpeechRecognition();
      activeRecognitions[index] = recognition;
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      // Cập nhật giao diện khi bắt đầu ghi âm
      recordBtn.textContent = "Stop";
      container.classList.add("recording");
      resultDiv.textContent = "Đang ghi âm...";

      recognition.start();

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const cleanSentence = removeStressMarkers(sentence).toLowerCase().trim();
        const cleanTranscript = transcript.toLowerCase().trim();
        let feedback = `Bạn nói: "${transcript}"`;
        if (cleanTranscript === cleanSentence) {
          feedback += " - Tuyệt vời!";
        } else {
          feedback += " - Hãy thử lại.";
        }
        resultDiv.textContent = feedback;
      };

      recognition.onerror = function(event) {
        resultDiv.textContent = "Lỗi: " + event.error;
      };

      recognition.onend = function() {
        recordBtn.textContent = "Record";
        container.classList.remove("recording");
        delete activeRecognitions[index];
      };
    }
  </script>
</body>
</html>
