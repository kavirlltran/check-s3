<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pronunciation Test</title>
  <style>
    /* Background: futuristic AI robot image */
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: url('https://source.unsplash.com/1600x900/?robot,AI,futuristic') no-repeat center center fixed;
      background-size: cover;
    }
    .overlay {
      background-color: rgba(0, 0, 0, 0.6);
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 20px;
      color: #fff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }
    p.instruction {
      text-align: center;
      color: #fff;
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    /* 3D-styled sentence list */
    #sentence-list {
      max-width: 800px;
      margin: 0 auto 20px auto;
    }
    .sentence-item {
      background-color: #fff;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .sentence-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    .sentence-item.selected {
      background-color: #e3f2fd;
      border-color: #2196f3;
    }
    /* Controls */
    #controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #record-btn {
      padding: 10px 20px;
      font-size: 1.2em;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #2196f3;
      color: #fff;
      transition: background-color 0.3s;
    }
    #record-btn:hover {
      background-color: #1976d2;
    }
    /* 3D-styled feedback box */
    #feedback {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      color: #333;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-align: center;
      font-size: 1.2em;
      line-height: 1.4;
    }
    /* Style for mispronounced words: bright yellow highlight */
    .error-word {
      background-color: #ffeb3b;
      color: #000;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1>Pronunciation Test</h1>
    <p class="instruction">
      Select a sentence below and click <strong>Record</strong> to start. Words marked with a <code>'</code> (or <code>‘</code>) indicate stress.
    </p>
    
    <!-- Sentence selection list -->
    <div id="sentence-list"></div>
    
    <!-- Single Record/Stop button -->
    <div id="controls">
      <button id="record-btn">Record</button>
    </div>
    
    <!-- Feedback section -->
    <div id="feedback"></div>
  </div>
  
  <script>
    // List of sentences (with stress markers)
    const sentences = [
      "We should ‘finish the ‘project for our ‘history ‘class",
      "‘Peter is re‘vising for his e‘xam ‘next ‘week.",
      "‘Students will ‘spend more ‘time ‘working with ‘other ‘classmates.",
      "I ‘like to ‘watch ‘videos that ‘help me ‘learn ‘new ‘things",
      "I have ‘installed some ‘apps on my ‘phone"
    ];
    
    let selectedSentenceIndex = null;
    let isRecording = false;
    let recognition = null;
    
    // Remove stress markers from text for comparison
    function removeStressMarkers(text) {
      return text.replace(/['‘’]/g, "");
    }
    
    // Compare words between the expected sentence and transcript
    // Returns an object with the output HTML, number of errors, and total words.
    function diffWords(correctSentence, transcript) {
      const correctWords = correctSentence.trim().toLowerCase().split(/\s+/);
      const transcriptWords = transcript.trim().toLowerCase().split(/\s+/);
      let output = "";
      let errors = 0;
      const maxLen = Math.max(correctWords.length, transcriptWords.length);
      for (let i = 0; i < maxLen; i++) {
        const cw = correctWords[i] || "";
        const tw = transcriptWords[i] || "";
        if (cw === tw && tw !== "") {
          output += tw + " ";
        } else {
          errors++;
          if (tw !== "") {
            output += `<span class="error-word">${tw}</span> `;
          } else if (cw !== "") {
            output += `<span class="error-word">[${cw}]</span> `;
          }
        }
      }
      return { output, errors, total: maxLen };
    }
    
    // Create the sentence list with 3D-styled boxes
    const sentenceListDiv = document.getElementById("sentence-list");
    sentences.forEach((sentence, index) => {
      const sentenceDiv = document.createElement("div");
      sentenceDiv.className = "sentence-item";
      sentenceDiv.textContent = sentence;
      sentenceDiv.addEventListener("click", () => {
        // Mark the selected sentence
        document.querySelectorAll(".sentence-item").forEach(item => item.classList.remove("selected"));
        sentenceDiv.classList.add("selected");
        selectedSentenceIndex = index;
        // Clear previous feedback
        document.getElementById("feedback").innerHTML = "";
      });
      sentenceListDiv.appendChild(sentenceDiv);
    });
    
    // Check for Web Speech API support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Your browser does not support the Speech Recognition API. Please use Chrome or Edge.");
    }
    
    const recordBtn = document.getElementById("record-btn");
    const feedbackDiv = document.getElementById("feedback");
    
    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        // Ensure a sentence is selected before starting
        if (selectedSentenceIndex === null) {
          alert("Please select a sentence to record.");
          return;
        }
        // Reset transcript and create a new recognition instance
        recognition = new SpeechRecognition();
        recognition.continuous = true; // Do not auto-stop on silence
        recognition.interimResults = true;
        recognition.lang = "en-US";
        
        recognition.onresult = function(event) {
          let transcript = "";
          // Instead of accumulating globally, process the full results each time
          for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript + " ";
          }
          transcript = transcript.trim();
          const correctSentence = removeStressMarkers(sentences[selectedSentenceIndex]);
          const result = diffWords(correctSentence, transcript);
          // Display the diff output with mispronounced words highlighted in yellow
          feedbackDiv.innerHTML = result.output;
          // Provide concise summary feedback
          if (result.errors === 0) {
            feedbackDiv.innerHTML += `<div style="margin-top: 10px;">Excellent! Perfect pronunciation.</div>`;
          } else {
            feedbackDiv.innerHTML += `<div style="margin-top: 10px;">${result.errors} error(s) out of ${result.total} words.</div>`;
          }
        };
        
        recognition.onerror = function(event) {
          console.error("Recognition error: ", event.error);
        };
        
        recognition.onend = function() {
          isRecording = false;
          recordBtn.textContent = "Record";
        };
        
        recognition.start();
        isRecording = true;
        recordBtn.textContent = "Stop";
      } else {
        // Stop recording on button click
        recognition.stop();
        isRecording = false;
        recordBtn.textContent = "Record";
      }
    });
  </script>
</body>
</html>
